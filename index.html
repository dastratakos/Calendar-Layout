<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar Layout Demo</title>
  <style>
    :root {
      /* Light mode colors */
      --bg-color: #ffffff;
      --text-color: #2c3e50;
      --button-bg: #f8f9fa;
      --button-border: #dee2e6;
      --button-hover: #e9ecef;
      --calendar-bg: #f8f9fa;
      --hour-line: #ddd;
      --time-label: #666;
    }

    [data-theme="dark"] {
      /* Dark mode colors */
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --button-bg: #2d2d2d;
      --button-border: #404040;
      --button-hover: #404040;
      --calendar-bg: #2a2a2a;
      --hour-line: #444;
      --time-label: #ccc;
    }

    body {
      font-family: sans-serif;
      padding: 20px;
      display: flex;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .header {
      position: fixed;
      top: 0;
      right: 0;
      padding: 20px;
      z-index: 100;
    }

    .theme-toggle {
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-toggle:hover {
      background: var(--button-hover);
    }

    .theme-icon {
      font-size: 16px;
    }

    .time-labels {
      width: 60px;
      text-align: right;
      padding-right: 10px;
      position: relative;
    }

    .time-label {
      position: absolute;
      width: 100%;
      font-size: 12px;
      transform: translateY(-6px);
      color: var(--time-label);
      transition: color 0.3s ease;
    }

    .calendar-container {
      position: relative;
      flex-grow: 1;
    }

    .calendar {
      position: relative;
      width: 600px;
      height: 1440px;
      /* 24 hours * 60 minutes, 1px per minute */
      border: 1px solid var(--button-border);
      background: var(--calendar-bg);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .hour-line {
      position: absolute;
      width: 100%;
      height: 1px;
      background-color: var(--hour-line);
      transition: background-color 0.3s ease;
    }

    .event {
      position: absolute;
      border-radius: 4px;
      box-sizing: border-box;
      padding: 4px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      border: 1px solid rgba(0, 0, 0, 0.2);
      opacity: 0.85;
    }

    .event-title {
      font-weight: bold;
      font-size: 12px;
      color: var(--text-color);
    }

    .event-location {
      font-size: 10px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .current-time-line {
      position: absolute;
      width: 100%;
      height: 1px;
      background-color: red;
      z-index: 10;
    }

    .current-time-label {
      position: absolute;
      right: 100%;
      margin-right: 5px;
      color: red;
      font-size: 12px;
      transform: translateY(-50%);
      z-index: 10;
    }
  </style>
</head>

<body>
  <div class="header">
    <button class="theme-toggle" id="themeToggle">
      <span class="theme-icon" id="themeIcon">🌙</span>
      <span id="themeText">Dark Mode</span>
    </button>
  </div>
  <div class="time-labels" id="time-labels"></div>
  <div class="calendar-container">
    <div class="calendar" id="calendar"></div>
  </div>

  <script>
    class ThemeToggle {
      constructor() {
        this.currentTheme = this.getStoredTheme() || 'light';
        this.themeToggle = document.getElementById('themeToggle');
        this.themeIcon = document.getElementById('themeIcon');
        this.themeText = document.getElementById('themeText');

        this.init();
      }

      init() {
        // Apply initial theme
        this.applyTheme(this.currentTheme);

        // Add event listener
        this.themeToggle.addEventListener('click', () => {
          this.toggleTheme();
        });
      }

      toggleTheme() {
        this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
        this.applyTheme(this.currentTheme);
        this.storeTheme(this.currentTheme);
        renderCalendar(events); // Re-render calendar with new theme
      }

      applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);

        if (theme === 'dark') {
          this.themeIcon.textContent = '☀️';
          this.themeText.textContent = 'Light Mode';
        } else {
          this.themeIcon.textContent = '🌙';
          this.themeText.textContent = 'Dark Mode';
        }
      }

      storeTheme(theme) {
        document.body.setAttribute('data-stored-theme', theme);
      }

      getStoredTheme() {
        return document.body.getAttribute('data-stored-theme');
      }
    }

    // Initialize theme toggle when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new ThemeToggle();
    });

    const TOTAL_WIDTH = 600;
    const INDENT_WIDTH = 10;
    const THRESHOLD_MINS = 30;

    const LIGHT_COLORS = [
      "#FFF689AA",
      "#F4D35EAA",
      "#FFB88AAA",
      "#FF9C5BAA",
      "#F67B45AA",
      "#FBC2C2AA",
      "#E39B99AA",
      "#CB7876AA",
      "#B4CFA4AA",
      "#8BA47CAA",
      "#62866CAA",
      "#A0C5E3AA",
      "#81B2D9AA",
      "#32769BAA",
      "#BBA6DDAA",
      "#8C7DA8AA",
      "#64557BAA",
      "#1E2136AA"
    ];

    const DARK_COLORS = [
      "#FFD700AA", // Bright yellow
      "#FF6B6BAA", // Coral red
      "#4ECDC4AA", // Turquoise
      "#45B7D1AA", // Sky blue
      "#96CEB4AA", // Sage green
      "#FFEEADAA", // Cream
      "#D4A5A5AA", // Dusty rose
      "#9B59B6AA", // Purple
      "#3498DBAA", // Blue
      "#E67E22AA", // Orange
      "#2ECC71AA", // Emerald
      "#F1C40FAA"  // Yellow
    ];

    function getEventColor() {
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const colors = isDarkMode ? DARK_COLORS : LIGHT_COLORS;
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // const events = [
    //   { id: 1, title: "Team Sync", location: "Room A", start: 540, end: 600 },
    //   { id: 2, title: "Client Call", location: "Room B", start: 555, end: 600 },
    //   { id: 3, title: "1:1", location: "Room C", start: 585, end: 615 },
    //   { id: 4, title: "Review Meeting", location: "Room D", start: 620, end: 660 },
    //   { id: 5, title: "Design Session", location: "Room E", start: 625, end: 665 },
    // ];

    const events = Array.from({ length: 50 }, (_, i) => {
      const start = Math.floor(Math.random() * (1440 - 60));
      const end = start + Math.floor(30 + Math.random() * 90);
      return {
        id: 0,
        title: "X",
        location: `Room ${String.fromCharCode(65 + (i % 26))}`,
        start,
        end: Math.min(end, 1440)
      };
    }).sort((a, b) => {
      if (a.start !== b.start) return a.start - b.start;
      return b.end - a.end;
    }).map((event, idx) => {
      event.id = idx + 1;
      event.title = `Event ${idx + 1}`;
      return event;
    });

    // const events = [
    //   { id: 1, title: "Overlap Start A", location: "Room A", start: 60, end: 120 },
    //   { id: 2, title: "Overlap Start B", location: "Room B", start: 75, end: 135 },
    //   { id: 3, title: "Overlap Start C", location: "Room C", start: 90, end: 150 },
    //   { id: 4, title: "Nested A", location: "Room D", start: 200, end: 400 },
    //   { id: 5, title: "Nested B", location: "Room E", start: 250, end: 300 },
    //   { id: 6, title: "Nested C", location: "Room F", start: 310, end: 390 },
    //   { id: 7, title: "End-To-Start A", location: "Room G", start: 500, end: 540 },
    //   { id: 8, title: "End-To-Start B", location: "Room H", start: 540, end: 580 },
    //   { id: 9, title: "Wide Event", location: "Room I", start: 600, end: 900 },
    //   { id: 10, title: "Quick Meeting", location: "Room J", start: 900, end: 915 },
    //   { id: 11, title: "Midnight Start", location: "Room K", start: 0, end: 30 },
    //   { id: 12, title: "Before Midnight", location: "Room L", start: 1410, end: 1440 },
    //   { id: 13, title: "Touching Edge A", location: "Room M", start: 1000, end: 1030 },
    //   { id: 14, title: "Touching Edge B", location: "Room N", start: 1030, end: 1060 },
    //   { id: 15, title: "Exact Half Hour A", location: "Room O", start: 1100, end: 1130 },
    //   { id: 16, title: "Exact Half Hour B", location: "Room P", start: 1130, end: 1160 },
    //   { id: 17, title: "Exact 30 min overlap", location: "Room Q", start: 1200, end: 1250 },
    //   { id: 18, title: "Another 30 min overlap", location: "Room R", start: 1220, end: 1270 },
    //   { id: 19, title: "Long All Day", location: "Room S", start: 60, end: 1380 },
    //   { id: 20, title: "Tiny Gap A", location: "Room T", start: 1300, end: 1320 },
    //   { id: 21, title: "Tiny Gap B", location: "Room U", start: 1321, end: 1340 },
    //   { id: 22, title: "Short Meeting A", location: "Room V", start: 300, end: 320 },
    //   { id: 23, title: "Short Meeting B", location: "Room W", start: 300, end: 305 },
    //   { id: 24, title: "Short Meeting C", location: "Room X", start: 305, end: 315 },
    //   { id: 25, title: "Late Night A", location: "Room Y", start: 1380, end: 1430 }
    // ];

    function eventsConflict(event1, event2) {
      return Math.abs(event1.start - event2.start) < THRESHOLD_MINS;
    }

    function buildRows(events) {
      let rows = [];
      let currRow = [];
      for (const event of events) {
        if (currRow.length === 0) {
          currRow.push(event);
          continue;
        }

        if (eventsConflict(event, currRow[0]) &&
          currRow[0].end >= event.start) {
          currRow.push(event);
          continue;
        }

        // start a new row
        rows.push(currRow);
        currRow = [event];
      }

      if (currRow.length > 0) {
        rows.push(currRow);
      }

      return rows;
    }

    function distributeHorizontally(rows) {
      // first row: split events equally across total width
      if (rows.length > 0 && rows[0].length > 0) {
        const eventWidth = TOTAL_WIDTH / rows[0].length;
        rows[0].forEach((event, idx) => {
          event.leftWithoutIndents = idx * eventWidth;
          event.left = idx * eventWidth;
          event.width = eventWidth;
        });
      }

      for (let rowIdx = 1; rowIdx < rows.length; rowIdx++) {
        const prevRow = rows[rowIdx - 1];
        const currRow = rows[rowIdx];

        let prevIdx = 0;
        let currIdx = 0;
        let currLeftStart = 0;
        let currIdxStart = currIdx;
        let availableWidth = 0;
        while (currIdx < currRow.length) {
          // advance prevIdx, keeping track of availableWidth
          while (
            prevIdx < prevRow.length &&
            (!eventsConflict(currRow[currIdx], prevRow[prevIdx]) ||
              prevRow[prevIdx].end < currRow[currIdx].start)
          ) {
            availableWidth += prevRow[prevIdx].width;
            prevIdx += 1;
          }
          if (prevIdx === prevRow.length) {
            // add remaining width to the right of prevRow[prevIdx]
            availableWidth += TOTAL_WIDTH - (prevRow[prevIdx - 1].leftWithoutIndents + prevRow[prevIdx - 1].width);
            currIdx = currRow.length;
          } else {
            // advance currIdx
            while (
              currIdx < currRow.length &&
              eventsConflict(currRow[currIdx], prevRow[prevIdx])
            ) {
              currIdx += 1;
            }
          }
          // update curr widths
          const numEvents = currIdx - currIdxStart;
          const eventWidth = availableWidth / numEvents;

          for (let i = 0; i < numEvents; i++) {
            currRow[currIdxStart + i].leftWithoutIndents = currLeftStart + i * eventWidth;
            currRow[currIdxStart + i].width = eventWidth;
          }

          // reset for next iteration
          currLeftStart += availableWidth;
          currIdxStart = currIdx;
          availableWidth = 0;
        }
      }
    }

    function addIndents(rows) {
      let leftToEvent = {};
      for (const row of rows) {
        for (const event of row) {
          const roundedLeft = Math.round(event.leftWithoutIndents);
          event.left = event.leftWithoutIndents;
          if (!(roundedLeft in leftToEvent)) {
            leftToEvent[roundedLeft] = [event];
            continue;
          }

          for (const e of leftToEvent[roundedLeft]) {
            if (event.start < e.end) {
              event.left = e.left + INDENT_WIDTH;
            }
          }
          event.width -= (event.left - event.leftWithoutIndents);
          leftToEvent[roundedLeft].push(event);
        }
      }
    }

    function layoutEvents(events) {
      // sort rows
      const sorted = events.slice().sort((a, b) => {
        if (a.start !== b.start) return a.start - b.start;
        return b.end - a.end;
      });

      // add fields for computing box
      const calendarEvents = sorted.map(
        (event) => ({
          ...event,
          top: event.start,
          height: event.end - event.start,
          leftWithoutIndents: 0,
          left: 0,
          width: TOTAL_WIDTH,
          // numIndents: 0,
        })
      )

      const rows = buildRows(calendarEvents);
      distributeHorizontally(rows);
      addIndents(rows);

      // calendarEvents are updated in-place
      return calendarEvents;
    }

    function renderTimeLabels() {
      const container = document.getElementById("time-labels");
      for (let hour = 0; hour < 24; hour++) {
        const label = document.createElement("div");
        label.className = "time-label";
        label.style.top = `${hour * 60}px`;
        label.innerText = `${hour.toString().padStart(2, '0')}:00`;
        container.appendChild(label);
      }
    }

    function renderHourLines() {
      const calendar = document.getElementById("calendar");
      for (let hour = 0; hour < 24; hour++) {
        const line = document.createElement("div");
        line.className = "hour-line";
        line.style.top = `${hour * 60}px`;
        calendar.appendChild(line);
      }
    }

    function renderCurrentTimeLine() {
      const calendar = document.getElementById("calendar");
      const now = new Date();
      const minutes = now.getHours() * 60 + now.getMinutes();

      const line = document.createElement("div");
      line.className = "current-time-line";
      line.style.top = `${minutes}px`;

      const label = document.createElement("div");
      label.className = "current-time-label";
      label.style.top = `${minutes}px`;
      label.innerText = now.toTimeString().substring(0, 5);

      calendar.appendChild(line);
      calendar.appendChild(label);
    }

    function renderCalendar(events) {
      const container = document.getElementById("calendar");
      const layout = layoutEvents(events);

      layout.forEach(ev => {
        const div = document.createElement("div");
        div.className = "event";
        div.style.top = `${ev.top}px`;
        div.style.height = `${ev.height}px`;
        div.style.left = `${ev.left}px`;
        div.style.width = `${ev.width}px`;
        div.style.backgroundColor = getEventColor();
        div.innerHTML = `<div class="event-title">${ev.title}</div><div class="event-location">${ev.location}</div>`;
        container.appendChild(div);
      });
    }

    renderTimeLabels();
    renderHourLines();
    renderCurrentTimeLine();
    renderCalendar(events);

    setInterval(() => {
      const calendar = document.getElementById("calendar");
      const oldLine = calendar.querySelector(".current-time-line");
      const oldLabel = calendar.querySelector(".current-time-label");
      if (oldLine) oldLine.remove();
      if (oldLabel) oldLabel.remove();
      renderCurrentTimeLine();
    }, 60000);
  </script>
</body>

</html>